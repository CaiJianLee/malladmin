{"remainingRequest":"/Users/caijianli/Desktop/malladmin/node_modules/babel-loader/lib/index.js!/Users/caijianli/Desktop/malladmin/node_modules/eslint-loader/index.js??ref--13-0!/Users/caijianli/Desktop/malladmin/src/commonutils/aliOSS.js","dependencies":[{"path":"/Users/caijianli/Desktop/malladmin/src/commonutils/aliOSS.js","mtime":1582099472000},{"path":"/Users/caijianli/Desktop/malladmin/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/caijianli/Desktop/malladmin/node_modules/babel-loader/lib/index.js","mtime":499162500000},{"path":"/Users/caijianli/Desktop/malladmin/node_modules/eslint-loader/index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:aW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMub2JqZWN0LnRvLXN0cmluZyI7CmltcG9ydCAicmVnZW5lcmF0b3ItcnVudGltZS9ydW50aW1lIjsKaW1wb3J0IF9hc3luY1RvR2VuZXJhdG9yIGZyb20gIi9Vc2Vycy9jYWlqaWFubGkvRGVza3RvcC9tYWxsYWRtaW4vbm9kZV9tb2R1bGVzL0BiYWJlbC9ydW50aW1lLWNvcmVqczMvaGVscGVycy9lc20vYXN5bmNUb0dlbmVyYXRvciI7CgovKioNCiAqICBDcmVhdGVkIGJ5IHdhbmdBbGVuIG9uIDIwMTktMTItMTcgMTE6MzINCiAqLwppbXBvcnQgeyBnZXRBd3NJbmZvIH0gZnJvbSAiQC9jb21tb251dGlscy9yZXF1ZXN0IjsKaW1wb3J0IHN0b3JlIGZyb20gIkAvc3RvcmUvaW5kZXgiOwppbXBvcnQgeyBTVEFUVVNfQ09ERSB9IGZyb20gIkAvY29tbW9udXRpbHMvY29tbW9uIjsKaW1wb3J0IERvbk1lc3NhZ2UgZnJvbSAiQC9jb21tb251dGlscy9tZXNzYWdlIjsKaW1wb3J0IENvbXByZXNzb3IgZnJvbSAiY29tcHJlc3NvcmpzIjsKaW1wb3J0IE9TUyBmcm9tICJhbGktb3NzIjsKdmFyIE1lc3NhZ2UgPSBuZXcgRG9uTWVzc2FnZSgpOwovKioNCiAqIOWbvueJh+WOi+e8qQ0KICogQHBhcmFtIHtPYmplY3R9IGZpbGUNCiAqIEByZXR1cm5zIHtQcm9taXNlPHVua25vd24+fSBmaWxlDQogKiBAY29uc3RydWN0b3INCiAqLwoKZXhwb3J0IHZhciBDb21wcmVzc29ySW1nID0gZnVuY3Rpb24gQ29tcHJlc3NvckltZyhmaWxlKSB7CiAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgIG5ldyBDb21wcmVzc29yKGZpbGUsIHsKICAgICAgcXVhbGl0eTogMC42LAogICAgICBjb252ZXJ0U2l6ZTogNTAwICogMTAyNCwKICAgICAgc3VjY2VzczogZnVuY3Rpb24gc3VjY2VzcyhyZXN1bHQpIHsKICAgICAgICByZXNvbHZlKHJlc3VsdCk7CiAgICAgIH0sCiAgICAgIGVycm9yOiBmdW5jdGlvbiBlcnJvcihlcnIpIHsKICAgICAgICByZWplY3QoZXJyKTsKICAgICAgfQogICAgfSk7CiAgfSk7Cn07Ci8qKg0KICog6Zi/6YeM5LqR5o6l5Y+j5p6E5bu6b3Nz5a+56LGhDQogKiBAcGFyYW0ge1N0cmluZ30gZmlsZVR5cGUNCiAqIEBkZXNjcmlwdGlvbiDmoLnmja50b2tlbuivt+axgm9zc+aOpeWPo++8jOi/lOWbnm9zc+WunuWIlw0KICogQHJldHVybnMge1Byb21pc2U8e21zZzogKHN0cmluZ3xzdHJpbmd8bXNnKSwgc3RhdHVzOiBzdHJpbmd9Pn0gUHJvbWlzZQ0KICovCgpleHBvcnQgdmFyIE9zc1JlcXVzZXQgPQovKiNfX1BVUkVfXyovCmZ1bmN0aW9uICgpIHsKICB2YXIgX3JlZiA9IF9hc3luY1RvR2VuZXJhdG9yKAogIC8qI19fUFVSRV9fKi8KICByZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlKCkgewogICAgdmFyIGZpbGVUeXBlLAogICAgICAgIHRva2VuLAogICAgICAgIHJlc3BvbnNlLAogICAgICAgIF9hcmdzID0gYXJndW1lbnRzOwogICAgcmV0dXJuIHJlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUkKF9jb250ZXh0KSB7CiAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgc3dpdGNoIChfY29udGV4dC5wcmV2ID0gX2NvbnRleHQubmV4dCkgewogICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICBmaWxlVHlwZSA9IF9hcmdzLmxlbmd0aCA+IDAgJiYgX2FyZ3NbMF0gIT09IHVuZGVmaW5lZCA/IF9hcmdzWzBdIDogImltYWdlIjsKICAgICAgICAgICAgdG9rZW4gPSBzdG9yZS5zdGF0ZS51c2VyLnRva2VuOwogICAgICAgICAgICBfY29udGV4dC5uZXh0ID0gNDsKICAgICAgICAgICAgcmV0dXJuIGdldEF3c0luZm8odG9rZW4pOwoKICAgICAgICAgIGNhc2UgNDoKICAgICAgICAgICAgcmVzcG9uc2UgPSBfY29udGV4dC5zZW50OwogICAgICAgICAgICByZXR1cm4gX2NvbnRleHQuYWJydXB0KCJyZXR1cm4iLCBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICAgICAgaWYgKHJlc3BvbnNlLmNvZGUgPT09IFNUQVRVU19DT0RFLnN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgIHZhciBfcmVzcG9uc2UkcmVzdWx0JGFsaXkgPSByZXNwb25zZS5yZXN1bHQuYWxpeXVuSW5mbywKICAgICAgICAgICAgICAgICAgICBhY2Nlc3NLZXlJZCA9IF9yZXNwb25zZSRyZXN1bHQkYWxpeS5hY2Nlc3NLZXlJZCwKICAgICAgICAgICAgICAgICAgICBzZWNyZXRBY2Nlc3NLZXkgPSBfcmVzcG9uc2UkcmVzdWx0JGFsaXkuc2VjcmV0QWNjZXNzS2V5LAogICAgICAgICAgICAgICAgICAgIHNlc3Npb25Ub2tlbiA9IF9yZXNwb25zZSRyZXN1bHQkYWxpeS5zZXNzaW9uVG9rZW47CgogICAgICAgICAgICAgICAgaWYgKCFhY2Nlc3NLZXlJZCB8fCAhc2VjcmV0QWNjZXNzS2V5IHx8ICFzZXNzaW9uVG9rZW4pIHsKICAgICAgICAgICAgICAgICAgcmVqZWN0KHsKICAgICAgICAgICAgICAgICAgICBzdGF0dXM6ICJlcnJvciIsCiAgICAgICAgICAgICAgICAgICAgbXNnOiAi6ZSZ6K+v5L+h5oGv77ya57O757uf6L+U5ZueYWNjZXNzS2V5SWQvc2VjcmV0QWNjZXNzS2V5L3Nlc3Npb25Ub2tlbuS4uuepuiIKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIE1lc3NhZ2UuZXJyb3IoIuezu+e7n+mUmeivr++8jOivt+iBlOezu+i/kOe7tCIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZhciBlbmRwb2ludCA9IHN0b3JlLnN0YXRlLmFsaXl1bk9zcy5lbmRwb2ludDsKCiAgICAgICAgICAgICAgICBpZiAoIWVuZHBvaW50IHx8ICFzdG9yZS5zdGF0ZS5hbGl5dW5Pc3MpIHsKICAgICAgICAgICAgICAgICAgcmVqZWN0KHsKICAgICAgICAgICAgICAgICAgICBzdGF0dXM6ICJlcnJvciIsCiAgICAgICAgICAgICAgICAgICAgbXNnOiAi6ZSZ6K+v5L+h5oGv77ya57O757ufQWxpT1NTID0+IGVuZHBvaW505Li656m6IgogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgTWVzc2FnZS53YXJuaW5nKCLnmbvlvZXov4fmnJ/nlKjmiLfkv6Hmga/mnInor6/vvIzor7fph43mlrDnmbvlvZXlkI7ph43or5XvvIEiKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YXIgYnVja2V0ID0gZmlsZVR5cGUgPT09ICJpbWFnZSIgPyBzdG9yZS5zdGF0ZS5hbGl5dW5Pc3MuaW1nQnVja2V0IDogc3RvcmUuc3RhdGUuYWxpeXVuT3NzLnZkb0J1Y2tldDsKICAgICAgICAgICAgICAgIHJlc29sdmUobmV3IE9TUyh7CiAgICAgICAgICAgICAgICAgIGVuZHBvaW50OiBlbmRwb2ludCwKICAgICAgICAgICAgICAgICAgLy8g5LqR6LSm5Y+3QWNjZXNzS2V55pyJ5omA5pyJQVBJ6K6/6Zeu5p2D6ZmQ77yM5bu66K6u6YG15b6q6Zi/6YeM5LqR5a6J5YWo5pyA5L2z5a6e6Le177yM6YOo572y5Zyo5pyN5Yqh56uv5L2/55SoUkFN5a2Q6LSm5Y+35oiWU1RT77yM6YOo572y5Zyo5a6i5oi356uv5L2/55SoU1RT44CCCiAgICAgICAgICAgICAgICAgIGFjY2Vzc0tleUlkOiBhY2Nlc3NLZXlJZCwKICAgICAgICAgICAgICAgICAgYWNjZXNzS2V5U2VjcmV0OiBzZWNyZXRBY2Nlc3NLZXksCiAgICAgICAgICAgICAgICAgIGJ1Y2tldDogYnVja2V0LAogICAgICAgICAgICAgICAgICBzdHNUb2tlbjogc2Vzc2lvblRva2VuCiAgICAgICAgICAgICAgICB9KSk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChyZXNwb25zZS5jb2RlICE9PSBTVEFUVVNfQ09ERS50b2tlbkVycm9yKSB7CiAgICAgICAgICAgICAgICByZWplY3QoewogICAgICAgICAgICAgICAgICBzdGF0dXM6ICJlcnJvciIsCiAgICAgICAgICAgICAgICAgIG1zZzogcmVzcG9uc2UubXNnCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIE1lc3NhZ2UuZXJyb3IocmVzcG9uc2UubXNnKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmVqZWN0KHsKICAgICAgICAgICAgICAgICAgc3RhdHVzOiAiZXJyb3IiLAogICAgICAgICAgICAgICAgICBtc2c6ICLkuIrkvKDlpLHotKXvvIznvZHnu5zplJnor68iCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIE1lc3NhZ2UuZXJyb3IoIuS4iuS8oOWksei0pe+8jOi6q+S7veS/oeaBr+mUmeivryIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSkpOwoKICAgICAgICAgIGNhc2UgNjoKICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgIHJldHVybiBfY29udGV4dC5zdG9wKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LCBfY2FsbGVlKTsKICB9KSk7CgogIHJldHVybiBmdW5jdGlvbiBPc3NSZXF1c2V0KCkgewogICAgcmV0dXJuIF9yZWYuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9Owp9KCk7"},{"version":3,"sources":["/Users/caijianli/Desktop/malladmin/src/commonutils/aliOSS.js"],"names":["getAwsInfo","store","STATUS_CODE","DonMessage","Compressor","OSS","Message","CompressorImg","file","Promise","resolve","reject","quality","convertSize","success","result","error","err","OssRequset","fileType","token","state","user","response","code","aliyunInfo","accessKeyId","secretAccessKey","sessionToken","status","msg","endpoint","aliyunOss","warning","bucket","imgBucket","vdoBucket","accessKeySecret","stsToken","tokenError"],"mappings":"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","sourcesContent":["/**\r\n *  Created by wangAlen on 2019-12-17 11:32\r\n */\r\nimport { getAwsInfo } from \"@/commonutils/request\";\r\nimport store from \"@/store/index\";\r\nimport { STATUS_CODE } from \"@/commonutils/common\";\r\nimport DonMessage from \"@/commonutils/message\";\r\nimport Compressor from \"compressorjs\";\r\nimport OSS from \"ali-oss\";\r\nconst Message = new DonMessage();\r\n\r\n/**\r\n * 图片压缩\r\n * @param {Object} file\r\n * @returns {Promise<unknown>} file\r\n * @constructor\r\n */\r\nexport const CompressorImg = file => {\r\n  return new Promise((resolve, reject) => {\r\n    new Compressor(file, {\r\n      quality: 0.6,\r\n      convertSize: 500 * 1024,\r\n      success(result) {\r\n        resolve(result);\r\n      },\r\n      error(err) {\r\n        reject(err);\r\n      }\r\n    });\r\n  });\r\n};\r\n/**\r\n * 阿里云接口构建oss对象\r\n * @param {String} fileType\r\n * @description 根据token请求oss接口，返回oss实列\r\n * @returns {Promise<{msg: (string|string|msg), status: string}>} Promise\r\n */\r\nexport const OssRequset = async (fileType = \"image\") => {\r\n  const { token } = store.state.user;\r\n  const response = await getAwsInfo(token);\r\n  return new Promise((resolve, reject) => {\r\n    if (response.code === STATUS_CODE.success) {\r\n      const {\r\n        accessKeyId,\r\n        secretAccessKey,\r\n        sessionToken\r\n      } = response.result.aliyunInfo;\r\n      if (!accessKeyId || !secretAccessKey || !sessionToken) {\r\n        reject({\r\n          status: \"error\",\r\n          msg: \"错误信息：系统返回accessKeyId/secretAccessKey/sessionToken为空\"\r\n        });\r\n        Message.error(\"系统错误，请联系运维\");\r\n      }\r\n      const endpoint = store.state.aliyunOss.endpoint;\r\n      if (!endpoint || !store.state.aliyunOss) {\r\n        reject({\r\n          status: \"error\",\r\n          msg: \"错误信息：系统AliOSS => endpoint为空\"\r\n        });\r\n        Message.warning(\"登录过期用户信息有误，请重新登录后重试！\");\r\n      }\r\n      const bucket =\r\n        fileType === \"image\"\r\n          ? store.state.aliyunOss.imgBucket\r\n          : store.state.aliyunOss.vdoBucket;\r\n      resolve(\r\n        new OSS({\r\n          endpoint: endpoint, // 云账号AccessKey有所有API访问权限，建议遵循阿里云安全最佳实践，部署在服务端使用RAM子账号或STS，部署在客户端使用STS。\r\n          accessKeyId: accessKeyId,\r\n          accessKeySecret: secretAccessKey,\r\n          bucket: bucket,\r\n          stsToken: sessionToken\r\n        })\r\n      );\r\n    } else if (response.code !== STATUS_CODE.tokenError) {\r\n      reject({\r\n        status: \"error\",\r\n        msg: response.msg\r\n      });\r\n      Message.error(response.msg);\r\n    } else {\r\n      reject({\r\n        status: \"error\",\r\n        msg: \"上传失败，网络错误\"\r\n      });\r\n      Message.error(\"上传失败，身份信息错误\");\r\n    }\r\n  });\r\n};\r\n"]}]}